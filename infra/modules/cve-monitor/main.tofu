resource "google_logging_metric" "cve_scanner_runs" {
  project = var.project_id
  name    = "cve-scanner-runs"
  filter  = <<-EOT
    resource.type="gce_instance"
    jsonPayload.systemd_unit=~"cve-.*"
  EOT
  metric_descriptor {
    metric_kind = "DELTA"
    value_type  = "INT64"
    unit        = "1"
  }
}

resource "google_monitoring_notification_channel" "pubsub_ntfy" {
  project      = var.project_id
  display_name = "Pub/Sub ntfy"
  type         = "pubsub"
  labels = {
    topic = var.ntfy_topic_id
  }
}

resource "google_monitoring_alert_policy" "cve_scanner_missing" {
  project      = var.project_id
  display_name = "CVE Scanner Missing"
  combiner     = "OR"

  conditions {
    display_name = "No CVE scanner logs in 24h"
    condition_absent {
      filter   = "metric.type=\"logging.googleapis.com/user/${google_logging_metric.cve_scanner_runs.name}\" AND resource.type=\"gce_instance\""
      duration = "84600s"
      aggregations {
        alignment_period   = "3600s"
        per_series_aligner = "ALIGN_COUNT"
      }
    }
  }

  notification_channels = [google_monitoring_notification_channel.pubsub_ntfy.id]

  documentation {
    content   = "No CVE scanner activity in last 24 hours"
    mime_type = "text/markdown"
  }
}
