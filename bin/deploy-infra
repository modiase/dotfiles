#!/usr/bin/env bash
set -euo pipefail

auto_approve=false
force_unlock=false
auto_upgrade=false
project="modiase-infra"
while [[ $# -gt 0 ]]; do
    case "$1" in
        -y|--yes) auto_approve=true; shift ;;
        -f|--force-unlock) force_unlock=true; shift ;;
        -a|--auto-upgrade) auto_upgrade=true; shift ;;
        -p|--project) project="$2"; shift 2 ;;
        *) echo "Usage: deploy-infra [-y|--yes] [-f|--force-unlock] [-a|--auto-upgrade] [-p|--project PROJECT]" >&2; exit 1 ;;
    esac
done

export TF_VAR_project_id="$project"

REPO_ROOT="$(git rev-parse --show-toplevel)"
INFRA_DIR="$REPO_ROOT/infra"

cd "$INFRA_DIR"

if [[ ! -d .terraform ]]; then
    echo "Initialising tofu..."
    tofu init
elif [[ "$auto_upgrade" == "true" ]]; then
    echo "Upgrading providers..."
    tofu init -upgrade
fi

if [[ "$force_unlock" == "true" ]]; then
    lock_id=$(tofu plan -var-file=tofu.tfvars 2>&1 | sed 's/\x1b\[[0-9;]*m//g' | grep -A1 'Lock Info' | grep 'ID:' | awk -F': +' '{print $2}' || true)
    if [[ -n "$lock_id" ]]; then
        echo "Force unlocking state (ID: $lock_id)..."
        tofu force-unlock -force "$lock_id"
    fi
fi

planfile=$(mktemp)
trap 'rm -f "$planfile"' EXIT

echo "Planning..."
tofu plan -var-file=tofu.tfvars -out="$planfile"

if [[ "$auto_approve" == "false" ]]; then
    read -rp "Apply? [y/N] " confirm
    [[ "$confirm" =~ ^[Yy]$ ]] || exit 0
fi

tofu apply "$planfile"
