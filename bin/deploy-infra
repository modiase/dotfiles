#!/usr/bin/env bash
set -euo pipefail

_TOFU=$(command -v tofu 2>/dev/null) || _TOFU="nix shell nixpkgs#opentofu -c tofu"
_SED=$(command -v gsed 2>/dev/null || command -v sed 2>/dev/null) || _SED="nix shell nixpkgs#gnused -c sed"
_GREP=$(command -v grep 2>/dev/null) || _GREP="nix shell nixpkgs#gnugrep -c grep"
_AWK=$(command -v gawk 2>/dev/null || command -v awk 2>/dev/null) || _AWK="nix shell nixpkgs#gawk -c awk"

auto_approve=false
force_unlock=false
auto_upgrade=false
project="modiase-infra"
while [[ $# -gt 0 ]]; do
    case "$1" in
        -y|--yes) auto_approve=true; shift ;;
        -f|--force-unlock) force_unlock=true; shift ;;
        -a|--auto-upgrade) auto_upgrade=true; shift ;;
        -p|--project) project="$2"; shift 2 ;;
        *) echo "Usage: deploy-infra [-y|--yes] [-f|--force-unlock] [-a|--auto-upgrade] [-p|--project PROJECT]" >&2; exit 1 ;;
    esac
done

export TF_VAR_project_id="$project"

REPO_ROOT="$(git rev-parse --show-toplevel)"
INFRA_DIR="$REPO_ROOT/infra"

cd "$INFRA_DIR"

if [[ ! -d .terraform ]]; then
    echo "Initialising tofu..."
    $_TOFU init
elif [[ "$auto_upgrade" == "true" ]]; then
    echo "Upgrading providers..."
    $_TOFU init -upgrade
fi

if [[ "$force_unlock" == "true" ]]; then
    lock_id=$($_TOFU plan -var-file=tofu.tfvars 2>&1 | $_SED 's/\x1b\[[0-9;]*m//g' | $_GREP -A1 'Lock Info' | $_GREP 'ID:' | $_AWK -F': +' '{print $2}' || true)
    if [[ -n "$lock_id" ]]; then
        echo "Force unlocking state (ID: $lock_id)..."
        $_TOFU force-unlock -force "$lock_id"
    fi
fi

planfile=$(mktemp)
trap 'rm -f "$planfile"' EXIT

echo "Planning..."
$_TOFU plan -var-file=tofu.tfvars -out="$planfile"

if [[ "$auto_approve" == "false" ]]; then
    read -rp "Apply? [y/N] " confirm
    [[ "$confirm" =~ ^[Yy]$ ]] || exit 0
fi

$_TOFU apply "$planfile"
