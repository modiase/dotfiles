repos:
  - repo: local
    hooks:
      - id: flake-check
        name: validate flake
        entry: bash
        language: system
        files: \.nix$
        pass_filenames: false
        args:
          - -c
          - "nix --extra-experimental-features 'nix-command flakes' flake show --no-write-lock-file &>/dev/null"
      - id: format-nix
        name: format nix files
        entry: bash
        language: system
        files: \.nix$
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p fd nixfmt --run 'fd -e nix -x nixfmt'"
      - id: format-lua
        name: format lua files
        entry: bash
        language: system
        files: \.lua$
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p stylua --run 'stylua .'"
      - id: format-fish
        name: format fish files
        entry: bash
        language: system
        files: \.fish$
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p fd fish --run 'fd -e fish -x fish_indent -w'"
      - id: format-go
        name: format go files
        entry: bash
        language: system
        files: \.go$
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p fd go --run 'fd -e go -x gofmt -w'"
      - id: lint-go
        name: lint go files
        entry: bash
        language: system
        files: \.go$
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p fd go golangci-lint --run 'for dir in $(fd go.mod -x dirname); do (cd $dir && golangci-lint run ./...); done'"
      - id: ruff-check
        name: ruff check
        entry: bash
        language: system
        files: \.py$
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p ruff --run 'ruff check --fix .'"
      - id: ruff-format
        name: ruff format
        entry: bash
        language: system
        files: \.py$
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p ruff --run 'ruff format .'"
      - id: lint-typescript
        name: lint typescript
        entry: bash
        language: system
        files: ^systems/hekate/run/dashboard/webui/src/.*\.(ts|html)$
        pass_filenames: false
        args:
          - -c
          - "cd systems/hekate/run/dashboard/webui && pnpm run lint"
      - id: organize-imports
        name: organize typescript imports
        entry: bash
        language: system
        files: ^systems/hekate/run/dashboard/webui/src/.*\.ts$
        pass_filenames: false
        args:
          - -c
          - "cd systems/hekate/run/dashboard/webui && pnpm dlx organize-imports-cli src/app/**/*.ts"
      - id: bash-syntax
        name: bash syntax check
        entry: bash
        language: system
        files: (\.(sh|bash)$|^bin/)
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p fd --run 'fd -e sh -e bash -E worktrees -x bash -n && for f in bin/activate bin/bootstrap; do [ -f \"$f\" ] && bash -n \"$f\"; done'"
      - id: fish-syntax
        name: fish syntax check
        entry: bash
        language: system
        files: \.fish$
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p fd fish --run 'fd -e fish -x fish --no-execute'"
      - id: shellcheck
        name: shellcheck
        entry: bash
        language: system
        files: (\.(sh|bash)$|^bin/)
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p shellcheck fd --run 'fd -e sh -e bash -E worktrees | xargs -r shellcheck; shellcheck bin/activate bin/bootstrap'"
      - id: shfmt
        name: shfmt
        entry: bash
        language: system
        files: (\.(sh|bash)$|^bin/)
        pass_filenames: false
        args:
          - -c
          - "nix-shell -p shfmt fd --run 'shfmt -w -i 4 -ci $(fd -e sh -e bash -E worktrees) bin/activate bin/bootstrap'"
      - id: remove-trailing-whitespace
        name: remove trailing whitespace
        entry: bash
        language: system
        files: .*
        pass_filenames: false
        args:
          - -c
          - 'nix-shell -p gnused --run ''git diff --cached --name-only --diff-filter d | grep -vE "\.(png|ico|jpg|jpeg|gif|webp|woff|woff2|ttf|eot|pdf)$" | xargs -r sed -i "s/[[:space:]]*$//"'''
      - id: format-terraform
        name: format terraform
        entry: bash
        language: system
        files: ^infra/.*\.tofu$
        pass_filenames: false
        args:
          - -c
          - 'nix-shell -p opentofu --run "cd infra && tofu fmt"'
      - id: delete-merged-branches
        name: delete merged branches on main
        entry: bash
        language: system
        always_run: true
        pass_filenames: false
        stages: [post-checkout]
        args:
          - -c
          - 'if [ "$(git branch --show-current)" = "main" ]; then git branch --merged main | grep -v main | xargs -r git branch -d; fi'
