"""Git repository sync with git-crypt support."""

import base64
import subprocess
import tempfile
from pathlib import Path

from loguru import logger


def repo_is_unlocked(repo_dir: Path) -> bool:
    """Check if repo has been unlocked with git-crypt."""
    keys_dir = repo_dir / ".git" / "git-crypt" / "keys" / "default"
    return keys_dir.exists()


def fetch_gcp_secret(secret_name: str, project: str = "modiase-infra") -> bytes:
    """Fetch secret from GCP Secret Manager.

    Secrets are stored as JSON with a 'value' field, base64 encoded.
    """
    result = subprocess.run(
        f"gcloud secrets versions access latest "
        f"--secret={secret_name} --project={project} | jq -r '.value'",
        shell=True,
        capture_output=True,
    )
    if result.returncode != 0:
        raise RuntimeError(
            f"Failed to fetch secret {secret_name}: {result.stderr.decode()}"
        )
    return base64.b64decode(result.stdout.strip())


def sync_repo(
    repo_url: str,
    repo_dir: Path,
    git_crypt_key: Path | None = None,
    gcp_key_secret: str | None = None,
) -> Path:
    """Clone/pull repo and unlock with git-crypt if needed.

    Idempotent: safe to call multiple times.
    - Clone only on first run
    - Fetch+reset on subsequent runs
    - Unlock only if repo is still encrypted
    """
    logger.debug(f"Syncing repo to {repo_dir}")

    if repo_dir.exists() and (repo_dir / ".git").is_dir():
        logger.info(f"Updating existing repo at {repo_dir}")
        subprocess.run(
            ["git", "-C", str(repo_dir), "fetch", "origin"],
            check=True,
        )
        subprocess.run(
            ["git", "-C", str(repo_dir), "reset", "--hard", "origin/main"],
            check=True,
        )
    else:
        logger.info(f"Cloning {repo_url} to {repo_dir}")
        repo_dir.parent.mkdir(parents=True, exist_ok=True)
        subprocess.run(["git", "clone", repo_url, str(repo_dir)], check=True)

    if repo_is_unlocked(repo_dir):
        logger.debug("Repo already unlocked, skipping git-crypt")
        return repo_dir

    logger.info("Repo is encrypted, unlocking with git-crypt")

    temp_key = None
    if git_crypt_key:
        key_path = git_crypt_key
    elif gcp_key_secret:
        key_data = fetch_gcp_secret(gcp_key_secret)
        temp_key = tempfile.NamedTemporaryFile(delete=False)
        temp_key.write(key_data)
        temp_key.close()
        key_path = Path(temp_key.name)
    else:
        raise RuntimeError(
            "Repo is encrypted but no git-crypt key provided. "
            "Use --git-crypt-key or --gcp-key-secret"
        )

    try:
        subprocess.run(
            ["git-crypt", "unlock", str(key_path)],
            cwd=repo_dir,
            check=True,
        )
        logger.info("Repo unlocked successfully")
    finally:
        if temp_key:
            Path(temp_key.name).unlink(missing_ok=True)

    return repo_dir
