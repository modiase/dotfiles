"""Shared utilities for CVE scanner."""

import sys
from datetime import datetime, timedelta, timezone
from pathlib import Path

from loguru import logger


def configure_logging(debug: bool) -> None:
    """Configure loguru logging."""
    logger.remove()
    level = "DEBUG" if debug else "INFO"
    logger.add(
        sys.stderr,
        format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <level>{message}</level>",
        level=level,
        colorize=True,
    )


def load_products(path: Path) -> list[str]:
    """Load products from file (plain text or Nix list format)."""
    if not path.exists():
        logger.warning(f"Products file not found: {path}")
        return []

    products = []
    for line in path.read_text().splitlines():
        line = line.strip()
        if not line or line.startswith("#") or line in ("[", "]"):
            continue
        line = line.strip('"').strip("'").rstrip(",")
        if line:
            products.append(line)

    logger.debug(f"Loaded {len(products)} products from {path}")
    return products


def get_last_check_date(state_dir: Path, default_days: int = 7) -> str:
    """Get last check date or default to N days ago."""
    last_check_file = state_dir / "last-watchlist-check"
    if last_check_file.exists():
        date = last_check_file.read_text().strip()
        logger.debug(f"Last check date from file: {date}")
        return date

    date = (datetime.now(timezone.utc) - timedelta(days=default_days)).strftime(
        "%Y-%m-%dT00:00:00.000"
    )
    logger.debug(f"No last check file, defaulting to: {date}")
    return date


def save_last_check_date(state_dir: Path) -> None:
    """Save current time as last check date."""
    last_check_file = state_dir / "last-watchlist-check"
    date = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%S.000")
    last_check_file.write_text(date)
    logger.debug(f"Saved last check date: {date}")


def load_seen_cves(state_dir: Path) -> set[str]:
    """Load set of already-seen CVE IDs."""
    seen_file = state_dir / "seen-cves.txt"
    if not seen_file.exists():
        logger.debug("No seen CVEs file, starting fresh")
        return set()

    cves = set(seen_file.read_text().splitlines())
    logger.debug(f"Loaded {len(cves)} seen CVEs")
    return cves


def save_seen_cve(state_dir: Path, cve_id: str) -> None:
    """Append a CVE ID to the seen file."""
    seen_file = state_dir / "seen-cves.txt"
    with seen_file.open("a") as f:
        f.write(f"{cve_id}\n")
    logger.debug(f"Marked CVE as seen: {cve_id}")
