#!/usr/bin/env python3
"""CVE Scanner CLI - scan products for vulnerabilities and send alerts."""

import asyncio
import json
import sys
from datetime import datetime
from pathlib import Path

import click
from loguru import logger

from .digest import generate_digest
from .notifiers import EmailNotifier, GmailNotifier, NtfyNotifier, NtfyOptions
from .repo import sync_repo
from .scanner import (
    CVE,
    get_package_to_systems,
    get_system_packages,
    scan_products,
)
from .utils import (
    configure_logging,
    get_last_check_date,
    load_products,
    load_seen_cves,
    save_last_check_date,
    save_seen_cve,
)


@click.group()
@click.version_option(version="1.0.0")
def cli():
    """CVE Scanner - scan products for vulnerabilities via NVD API."""
    pass


@cli.command()
@click.option(
    "--products",
    "-p",
    multiple=True,
    help="Products to scan (can be specified multiple times)",
)
@click.option(
    "--products-file",
    "-f",
    type=click.Path(exists=True, path_type=Path),
    help="File with products (one per line or Nix list format)",
)
@click.option(
    "--state-dir",
    type=click.Path(path_type=Path),
    envvar="CVE_STATE_DIR",
    default="/var/lib/cve-scanner",
    help="State directory for tracking seen CVEs",
)
@click.option(
    "--api-key",
    envvar="NVD_API_KEY",
    help="NVD API key for higher rate limits",
)
@click.option(
    "--cvss-threshold",
    type=float,
    default=9.0,
    help="Minimum CVSS score to report",
)
@click.option(
    "--since-days",
    type=int,
    default=7,
    help="Check CVEs from N days ago (if no state file)",
)
@click.option(
    "--dry-run",
    "-n",
    is_flag=True,
    help="Don't update state files",
)
@click.option(
    "--output",
    "-o",
    type=click.Choice(["json", "text"]),
    default="text",
    help="Output format",
)
@click.option(
    "--refresh",
    is_flag=True,
    help="Ignore not-found cache and re-query all products",
)
@click.option(
    "--debug",
    "-d",
    is_flag=True,
    help="Enable debug logging",
)
def scan(
    products: tuple[str, ...],
    products_file: Path | None,
    state_dir: Path,
    api_key: str | None,
    cvss_threshold: float,
    since_days: int,
    dry_run: bool,
    output: str,
    refresh: bool,
    debug: bool,
):
    """Scan products for CVEs via NVD API."""
    configure_logging(debug)

    all_products = list(products)
    if products_file:
        all_products.extend(load_products(products_file))

    if not all_products:
        logger.error("No products specified. Use -p or -f options.")
        sys.exit(1)

    state_dir.mkdir(parents=True, exist_ok=True)
    last_check = get_last_check_date(state_dir, since_days)
    seen_cves = load_seen_cves(state_dir)

    logger.info(f"Scanning {len(all_products)} products since {last_check}")

    cves = asyncio.run(
        scan_products(
            tuple(all_products),
            last_check=last_check,
            api_key=api_key,
            cvss_threshold=cvss_threshold,
            state_dir=state_dir,
            refresh_cache=refresh,
        )
    )

    new_cves = [c for c in cves if c.id not in seen_cves]

    if not dry_run:
        for cve in new_cves:
            save_seen_cve(state_dir, cve.id)
        save_last_check_date(state_dir)

    if output == "json":
        result = [
            {
                "id": c.id,
                "score": c.score,
                "product": c.product,
                "description": c.description,
            }
            for c in new_cves
        ]
        click.echo(json.dumps(result))
    else:
        if new_cves:
            for c in new_cves:
                logger.warning(f"NEW: {c.id} (CVSS {c.score}) - {c.product}")
        else:
            logger.info("No new critical CVEs found")

    logger.info(f"Scan complete. Found {len(new_cves)} new critical CVEs.")


@cli.command()
@click.option(
    "--backend",
    "-b",
    type=click.Choice(["ntfy", "email", "gmail"]),
    required=True,
    help="Notification backend",
)
@click.option(
    "--input",
    "-i",
    "input_file",
    type=click.File("r"),
    default="-",
    help="CVE data as JSON, or raw HTML with --raw",
)
@click.option(
    "--raw",
    is_flag=True,
    help="Send raw HTML content instead of CVE JSON",
)
@click.option(
    "--subject",
    "-s",
    help="Email subject (required with --raw)",
)
@click.option(
    "--dry-run",
    "-n",
    is_flag=True,
    help="Test credentials and print message without sending",
)
@click.option("--ntfy-url", envvar="NTFY_URL", help="ntfy server URL")
@click.option("--ntfy-topic", envvar="NTFY_TOPIC", help="ntfy topic")
@click.option("--ntfy-auth", envvar="NTFY_AUTH", help="ntfy auth (user:pass or token)")
@click.option("--email-to", envvar="EMAIL_TO", help="Recipient email")
@click.option("--email-from", envvar="EMAIL_FROM", help="Sender email")
@click.option("--smtp-host", envvar="SMTP_HOST", help="SMTP server")
@click.option(
    "--smtp-port", envvar="SMTP_PORT", type=int, default=587, help="SMTP port"
)
@click.option("--smtp-user", envvar="SMTP_USER", help="SMTP username")
@click.option("--smtp-pass", envvar="SMTP_PASS", help="SMTP password")
@click.option(
    "--gmail-client-id", envvar="GMAIL_CLIENT_ID", help="Gmail OAuth2 client ID"
)
@click.option(
    "--gmail-client-secret",
    envvar="GMAIL_CLIENT_SECRET",
    help="Gmail OAuth2 client secret",
)
@click.option(
    "--gmail-refresh-token",
    envvar="GMAIL_REFRESH_TOKEN",
    help="Gmail OAuth2 refresh token",
)
@click.option("--gmail-address", envvar="GMAIL_ADDRESS", help="Gmail address")
@click.option("--from-name", envvar="FROM_NAME", help="Sender display name")
@click.option("--debug", "-d", is_flag=True, help="Enable debug logging")
def send(
    backend: str,
    input_file,
    raw: bool,
    subject: str | None,
    dry_run: bool,
    ntfy_url: str | None,
    ntfy_topic: str | None,
    ntfy_auth: str | None,
    email_to: str | None,
    email_from: str | None,
    smtp_host: str | None,
    smtp_port: int,
    smtp_user: str | None,
    smtp_pass: str | None,
    gmail_client_id: str | None,
    gmail_client_secret: str | None,
    gmail_refresh_token: str | None,
    gmail_address: str | None,
    from_name: str | None,
    debug: bool,
):
    """Send CVE alerts via ntfy, email, or gmail."""
    configure_logging(debug)

    if backend == "ntfy":
        if not ntfy_url or not ntfy_topic:
            logger.error("ntfy requires --ntfy-url and --ntfy-topic")
            sys.exit(1)
        notifier = NtfyNotifier(ntfy_url, ntfy_topic, ntfy_auth)
    elif backend == "email":
        if (
            smtp_host is None
            or smtp_user is None
            or smtp_pass is None
            or email_from is None
            or email_to is None
        ):
            raise ValueError(
                "email requires --smtp-host, --smtp-user, --smtp-pass, "
                "--email-from, and --email-to"
            )
        notifier = EmailNotifier(
            smtp_host=smtp_host,
            smtp_port=smtp_port,
            user=smtp_user,
            password=smtp_pass,
            from_addr=email_from,
            to_addr=email_to,
        )
    else:  # gmail
        if (
            gmail_client_id is None
            or gmail_client_secret is None
            or gmail_refresh_token is None
            or gmail_address is None
        ):
            raise ValueError(
                "gmail requires --gmail-client-id, --gmail-client-secret, "
                "--gmail-refresh-token, and --gmail-address"
            )
        notifier = GmailNotifier(
            gmail_client_id,
            gmail_client_secret,
            gmail_refresh_token,
            gmail_address,
            from_name=from_name or "CVE Scanner",
        )

    if raw:
        if backend == "ntfy":
            logger.error("ntfy backend does not support --raw mode")
            sys.exit(1)

        html_content = input_file.read()
        if not html_content.strip():
            logger.info("No content to send")
            return

        if not subject:
            subject = f"CVE Scan Report - {datetime.now().strftime('%Y-%m-%d')}"

        logger.info(f"Sending raw HTML via {backend}")
        success = asyncio.run(notifier.send_raw(subject, html_content, dry_run=dry_run))
    else:
        try:
            data = json.load(input_file)
        except json.JSONDecodeError as e:
            logger.error(f"Invalid JSON input: {e}")
            sys.exit(1)

        if not data:
            logger.info("No CVEs to send")
            if isinstance(notifier, NtfyNotifier):
                asyncio.run(
                    notifier.notify(
                        "No new vulnerabilities found",
                        NtfyOptions(
                            title="CVE Scan Complete",
                            priority=2,
                            tags="white_check_mark",
                        ),
                    )
                )
            return

        cves = [CVE(**item) for item in data]
        logger.info(f"Sending alerts for {len(cves)} CVEs via {backend}")
        success = asyncio.run(notifier.send(cves, dry_run=dry_run))

    if not success:
        sys.exit(1)


@cli.command("scan-system")
@click.option(
    "--flake",
    "-f",
    help="Flake reference (only used with --no-sync)",
)
@click.option(
    "--systems",
    "-s",
    required=True,
    help="Comma-separated NixOS system names to scan",
)
@click.option(
    "--state-dir",
    type=click.Path(path_type=Path),
    envvar="CVE_STATE_DIR",
    default="/var/lib/cve-scanner",
    help="State directory for tracking seen CVEs",
)
@click.option(
    "--no-sync",
    is_flag=True,
    help="Skip repo sync (use --flake directly)",
)
@click.option(
    "--repo-url",
    default="https://github.com/modiase/dotfiles.git",
    help="Git repo URL to sync",
)
@click.option(
    "--repo-dir",
    type=click.Path(path_type=Path),
    help="Local repo directory (default: {state-dir}/dotfiles)",
)
@click.option(
    "--git-crypt-key",
    type=click.Path(exists=True, path_type=Path),
    help="Path to git-crypt key file",
)
@click.option(
    "--gcp-key-secret",
    default="dotfiles-key",
    help="GCP secret name for git-crypt key",
)
@click.option(
    "--api-key",
    envvar="NVD_API_KEY",
    help="NVD API key for higher rate limits",
)
@click.option(
    "--cvss-threshold",
    type=float,
    default=7.0,
    help="Minimum CVSS score to report",
)
@click.option(
    "--since-days",
    type=int,
    default=30,
    help="Check CVEs from N days ago",
)
@click.option(
    "--output",
    "-o",
    type=click.Choice(["json", "html"]),
    default="html",
    help="Output format",
)
@click.option(
    "--output-file",
    type=click.File("w"),
    default="-",
    help="Output file (default: stdout)",
)
@click.option(
    "--dry-run",
    "-n",
    is_flag=True,
    help="Don't update state files",
)
@click.option(
    "--refresh",
    is_flag=True,
    help="Ignore not-found cache and re-query all products",
)
@click.option(
    "--debug",
    "-d",
    is_flag=True,
    help="Enable debug logging",
)
def scan_system(
    flake: str | None,
    systems: str,
    state_dir: Path,
    no_sync: bool,
    repo_url: str,
    repo_dir: Path | None,
    git_crypt_key: Path | None,
    gcp_key_secret: str,
    api_key: str | None,
    cvss_threshold: float,
    since_days: int,
    output: str,
    output_file,
    dry_run: bool,
    refresh: bool,
    debug: bool,
):
    """Scan NixOS system closures for CVEs."""
    configure_logging(debug)

    state_dir.mkdir(parents=True, exist_ok=True)

    if no_sync:
        if not flake:
            logger.error("--flake is required when using --no-sync")
            sys.exit(1)
        effective_flake = flake
    else:
        actual_repo_dir = repo_dir or (state_dir / "dotfiles")
        sync_repo(repo_url, actual_repo_dir, git_crypt_key, gcp_key_secret)
        effective_flake = f"path:{actual_repo_dir}"

    systems_tuple = tuple(s.strip() for s in systems.split(","))
    logger.info(f"Scanning systems: {', '.join(systems_tuple)}")

    system_packages = get_system_packages(effective_flake, systems_tuple)
    pkg_to_systems = get_package_to_systems(system_packages)

    all_packages = tuple(sorted(pkg_to_systems.keys()))
    if not all_packages:
        logger.error("No packages found to scan")
        sys.exit(1)

    logger.info(f"Found {len(all_packages)} unique packages to scan")
    state_dir.mkdir(parents=True, exist_ok=True)
    last_check = get_last_check_date(state_dir, since_days)
    seen_cves = load_seen_cves(state_dir)

    logger.info(f"Scanning packages for CVEs since {last_check}")
    cves = asyncio.run(
        scan_products(
            all_packages,
            last_check=last_check,
            api_key=api_key,
            cvss_threshold=cvss_threshold,
            state_dir=state_dir,
            refresh_cache=refresh,
        )
    )

    enriched_cves = tuple(
        CVE(
            id=c.id,
            score=c.score,
            description=c.description,
            product=c.product,
            systems=pkg_to_systems.get(c.product, frozenset()),
        )
        for c in cves
    )
    new_cves = tuple(c for c in enriched_cves if c.id not in seen_cves)

    if not dry_run:
        for cve in new_cves:
            save_seen_cve(state_dir, cve.id)
        save_last_check_date(state_dir)

    if output == "json":
        click.echo(
            json.dumps(
                [
                    {
                        "id": c.id,
                        "score": c.score,
                        "product": c.product,
                        "description": c.description,
                        "systems": sorted(c.systems),
                    }
                    for c in new_cves
                ]
            ),
            file=output_file,
        )
    else:
        click.echo(generate_digest(new_cves, system_packages), file=output_file)

    logger.info(f"Scan complete. Found {len(new_cves)} new CVEs.")


def main():
    cli()


if __name__ == "__main__":
    main()
