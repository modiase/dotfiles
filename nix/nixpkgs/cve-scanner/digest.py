"""HTML digest generation for CVE reports."""

import html
from datetime import datetime
from importlib import resources
from pathlib import Path

from .scanner import CVE


def _load_template(name: str) -> str:
    """Load HTML template from static directory."""
    static = resources.files(__package__).joinpath("static")
    return Path(str(static.joinpath(name))).read_text()


def _get_severity_class(score: float) -> str:
    if score >= 9.0:
        return "critical"
    if score >= 7.0:
        return "high"
    return "medium"


def _format_cve(cve: CVE, template: str) -> str:
    severity = _get_severity_class(cve.score)
    escaped_id = html.escape(cve.id)
    escaped_product = html.escape(cve.product)
    escaped_desc = html.escape(cve.description)
    desc = escaped_desc[:300] + "..." if len(escaped_desc) > 300 else escaped_desc
    return template.format(
        id=escaped_id,
        score=cve.score,
        severity=severity,
        product=escaped_product,
        description=desc,
    )


def generate_digest(
    cves: tuple[CVE, ...],
    systems: tuple[str, ...],
    package_count: int,
) -> str:
    digest_template = _load_template("digest.html")
    cve_template = _load_template("cve.html")
    date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    if not cves:
        content = '<p class="no-vulns">No vulnerabilities found.</p>'
    else:
        sorted_cves = sorted(cves, key=lambda c: c.score, reverse=True)
        content = "\n".join(_format_cve(cve, cve_template) for cve in sorted_cves)

    return digest_template.format(
        date=date,
        systems=", ".join(systems),
        package_count=package_count,
        vuln_count=len(cves),
        content=content,
    )
