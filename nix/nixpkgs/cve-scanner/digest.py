"""HTML digest generation for CVE reports."""

import html
from datetime import datetime
from importlib import resources
from pathlib import Path

from .scanner import CVE


def _load_template(name: str) -> str:
    """Load HTML template from static directory."""
    static = resources.files(__package__).joinpath("static")
    return Path(str(static.joinpath(name))).read_text()


def _get_severity_class(score: float) -> str:
    if score >= 9.0:
        return "critical"
    if score >= 7.0:
        return "high"
    return "medium"


def _format_cve(cve: CVE, template: str) -> str:
    severity = _get_severity_class(cve.score)
    escaped_id = html.escape(cve.id)
    escaped_product = html.escape(cve.product)
    escaped_desc = html.escape(cve.description)
    desc = escaped_desc[:300] + "..." if len(escaped_desc) > 300 else escaped_desc
    systems_str = ", ".join(sorted(cve.systems)) if cve.systems else "unknown"
    return template.format(
        id=escaped_id,
        score=cve.score,
        severity=severity,
        product=escaped_product,
        description=desc,
        systems=html.escape(systems_str),
    )


def _generate_system_stats(
    cves: tuple[CVE, ...],
    system_packages: dict[str, tuple[str, ...]],
) -> str:
    """Generate per-system stats table rows."""
    rows = []
    for system in sorted(system_packages.keys()):
        pkg_count = len(system_packages[system])
        vuln_count = sum(1 for c in cves if system in c.systems)
        rows.append(
            f"<tr><td>{html.escape(system)}</td>"
            f"<td>{pkg_count}</td><td>{vuln_count}</td></tr>"
        )
    return "\n".join(rows)


def generate_digest(
    cves: tuple[CVE, ...],
    system_packages: dict[str, tuple[str, ...]],
) -> str:
    digest_template = _load_template("digest.html")
    cve_template = _load_template("cve.html")
    date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    all_packages: set[str] = set()
    for packages in system_packages.values():
        all_packages.update(packages)
    total_packages = len(all_packages)

    if not cves:
        content = '<p class="no-vulns">No vulnerabilities found.</p>'
    else:
        sorted_cves = sorted(cves, key=lambda c: c.score, reverse=True)
        content = "\n".join(_format_cve(cve, cve_template) for cve in sorted_cves)

    system_stats = _generate_system_stats(cves, system_packages)

    return digest_template.format(
        date=date,
        systems=", ".join(sorted(system_packages.keys())),
        system_count=len(system_packages),
        package_count=total_packages,
        vuln_count=len(cves),
        system_stats=system_stats,
        content=content,
    )
