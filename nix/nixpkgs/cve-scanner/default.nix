{
  lib,
  stdenv,
  python3,
  makeWrapper,
  nix,
  git,
  git-crypt,
  google-cloud-sdk,
  jq,
}:

let
  pythonEnv = python3.withPackages (ps: [
    ps.aiohttp
    ps.click
    ps.loguru
  ]);
in
stdenv.mkDerivation {
  pname = "cve-scanner";
  version = "1.0.0";
  src = ./.;

  nativeBuildInputs = [ makeWrapper ];

  installPhase = ''
    mkdir -p $out/lib/cve_scanner $out/bin

    cp utils.py scanner.py notifiers.py main.py digest.py repo.py $out/lib/cve_scanner/
    cp -r static $out/lib/cve_scanner/
    echo "" > $out/lib/cve_scanner/__init__.py

    cat > $out/bin/.cve-scanner-unwrapped << 'WRAPPER'
    #!${pythonEnv}/bin/python3
    import sys
    sys.path.insert(0, "@out@/lib")
    from cve_scanner.main import main
    main()
    WRAPPER

    substituteInPlace $out/bin/.cve-scanner-unwrapped --replace "@out@" "$out"
    chmod +x $out/bin/.cve-scanner-unwrapped

    makeWrapper $out/bin/.cve-scanner-unwrapped $out/bin/cve-scanner \
      --prefix PATH : ${
        lib.makeBinPath [
          nix
          git
          git-crypt
          google-cloud-sdk
          jq
        ]
      }
  '';

  meta = {
    description = "CVE vulnerability scanner with NVD API integration";
    mainProgram = "cve-scanner";
  };
}
