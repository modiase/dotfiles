{
  lib,
  stdenv,
  python3,
  makeWrapper,
  n2c ? null,
  cacert,
  bashInteractive,
}:

let
  pythonEnv = python3.withPackages (ps: [
    ps.aiohttp
    ps.click
    ps.loguru
  ]);

  cve-scanner = stdenv.mkDerivation {
    pname = "cve-scanner";
    version = "1.0.0";
    src = ./.;

    nativeBuildInputs = [ makeWrapper ];

    installPhase = ''
      mkdir -p $out/lib/cve_scanner $out/bin

      cp utils.py scanner.py notifiers.py main.py $out/lib/cve_scanner/
      echo "" > $out/lib/cve_scanner/__init__.py

      cat > $out/bin/cve-scanner << 'WRAPPER'
      #!${pythonEnv}/bin/python3
      import sys
      sys.path.insert(0, "@out@/lib")
      from cve_scanner.main import main
      main()
      WRAPPER

      substituteInPlace $out/bin/cve-scanner --replace "@out@" "$out"
      chmod +x $out/bin/cve-scanner
    '';

    passthru = lib.optionalAttrs (n2c != null) {
      image = n2c.buildImage {
        name = "cve-scanner";
        tag = "latest";

        config = {
          entrypoint = [ "${cve-scanner}/bin/cve-scanner" ];
          env = [
            "SSL_CERT_FILE=${cacert}/etc/ssl/certs/ca-bundle.crt"
          ];
        };

        layers = [
          (n2c.buildLayer { deps = [ cve-scanner ]; })
          (n2c.buildLayer {
            deps = [
              cacert
              bashInteractive
            ];
          })
        ];
      };

      copyToDocker = cve-scanner.passthru.image.copyToDockerDaemon;
      copyToPodman = cve-scanner.passthru.image.copyToPodman;
    };

    meta = {
      description = "CVE vulnerability scanner with NVD API integration";
      mainProgram = "cve-scanner";
    };
  };
in
cve-scanner
